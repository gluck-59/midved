# Платежи (Payment)

## Назначение
- **Цель** Учитывать финансовые операции (приходы, расходы, авторазноску) в рамках заявок.

## Архитектура
- **Контроллер** `application/controllers/Payment.php` предоставляет маршруты `/payment/delete` и `/payment/edit`.
- **Модель** `application/models/PaymentModel.php` реализует выборку по заявке, создание, авторазноску, редактирование, удаление.
- **Представления**
  - `application/views/requestEdit.php` отображает историю платежей и предоставляет UI для редактирования.
  - `application/views/modals.php` (`#modalPrihodRashod`) используется для ручных операций.
- **JavaScript** `application/js/script.js` содержит обработчики `.paymentEdit`, `.deletePayment` и другие связанные функции.

## Структура данных
- **Таблица `payment`** фиксирует операции:
  - `id` — первичный ключ.
  - `request_id` — FK на `request.id`.
  - `type` — тип платежа (`PaymentModel::TYPES` отличают ручные и авторазноски).
  - `sum` — сумма в копейках (положительная приход, отрицательная расход).
  - `note` — комментарий.
  - `created` — дата операции.

## UI-потоки
- **Добавление/расход** выполняется через `#modalPrihodRashod`, вызванный из `requestEdit.php` или из `main.php`/`modals.php`.
- **Редактирование** в `requestEdit.php` таблица платежей позволяет изменять дату, сумму и заметку, отправляя `/payment/edit`.
- **Удаление** кнопка `.deletePayment` вызывает `/payment/delete`.
- **Авторазноска** инициируется через `script.js` при выборе клиента, вызывает `/request/payment` с `customerId`.

## API и обработчики
- **GET `/payment/get/{id}`** отсутствует; данные подтягиваются через `RequestModel::edit()` и `PaymentModel::get()`.
- **POST `/request/payment`** — добавление платежей или авторазноска (`PaymentModel::set()`, `PaymentModel::autoDistribution()`).
- **POST `/payment/edit`** — обновление суммы/примечаний (`PaymentModel::edit()`).
- **POST `/payment/delete`** — удаление (`PaymentModel::delete()`).

## Бизнес-правила
- **Суммы** хранятся в копейках; перед отображением делятся на 100.
- **Типы** `PaymentModel::TYPES` определяют категории: `Работа`, `Накладные`, `Авторазноска` — используются в UI для иконок и цвета.
- **Авторазноска** (`autoDistribution`) компенсирует отрицательные балансы незакрытых заявок клиента, добавляя платежи с типами `payment_type_autowork`/`payment_type_autoextra` и при необходимости помечая `note` как `Недостача`/`Излишек`.
- **Удаление** доступно через UI, но сопровождается подтверждением.

## Требования к базе данных
- **Связи** `payment.request_id` → `request.id` (ON DELETE/UPDATE CASCADE).
- **Индексы** `paym-req` ускоряет выборки по заявке.
- **Формат сумм** — хранить в INT для избежания ошибок округления.

## Расширение функциональности
- **Категории** можно расширить, добавив значения в `PaymentModel::TYPES` и обновив UI.
- **Валюты** потребуют новых столбцов и переработки расчётов.
- **Отчётность** строится на данных `payment`; см. `ReportModel`.

## Диагностика и отладка
- **AJAX** ответы `/payment/edit` и `/payment/delete` возвращают JSON c `toastr`.
- **SQL** операции `set()`/`autoDistribution()` используют `INSERT`/`UPDATE`/`DELETE`; проверяй лог БД при ошибках.
- **Ручные правки** в таблице платежей обновляются через Blur-события в JS, убедись в корректности отправляемых данных.
