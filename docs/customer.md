# Клиенты (Customer)

## Назначение
- **Цель** Обеспечить хранение и управление данными клиентов, на которых завязаны оборудование, заявки и платежи.

## Архитектура
- **Контроллер** `application/controllers/Customer.php` отвечает за маршруты `/customer`, `/customer/getAll`, `/customer/save`, `/customer/delete` и взаимодействует с `CustomerModel`.
- **Модель** `application/models/CustomerModel.php` агрегирует CRUD-операции, фильтрацию по текущему пользователю и разбиение клиентов на родителей/дочерних.
- **Представление** `application/views/customer.php` выводит дерево клиентов и кнопки действий.
- **JavaScript** `application/js/script.js` содержит обработчики модальных окон и AJAX-запросов.
- **Модальные окна** `application/views/modals.php` предоставляют UI для создания/редактирования клиента.

## Структура данных
- **Таблица `customer`** хранит базовые атрибуты клиента и связи:
  - `id` — первичный ключ.
  - `creator` — идентификатор пользователя (`users.id`), задаётся в `CustomerModel::create()` через `UserModel::getCurrentUser()`.
  - `parentId` — ссылка на родительского клиента, позволяет строить иерархию.
  - `name` — отображаемое название клиента.
  - `data` — произвольные дополнительные сведения.
- **Связанные сущности**
  - `equipment` (`application/models/EquipmentModel.php`) связывает оборудование с клиентом.
  - `request` и `payment` опосредованно завязаны на клиента через оборудование.

## UI-потоки
- **Список клиентов** `application/views/customer.php` делит ответ `CustomerModel::get()` на блоки родителей и дочерних. Пустой список сопровождается подсказкой о дальнейших шагах.
- **Создание/редактирование** кнопка "Новый клиент" (`#newCilent`) открывает модал `#modal-customer`. Поля `#name`, `#data` и выпадающий список родителей заполняются и отправляются через `#saveCustomer`.
- **Удаление** кнопка с классом `.deleteCustomer` инициирует подтверждение и отправляет запрос на `/customer/delete`.

## API и обработчики
- **GET `/customer`** отображает страницу с таблицей клиентов.
- **GET `/customer/getAll`** возвращает JSON-структуру (`parents`, `childs`) для заполнения выпадающих списков в модалях.
- **POST `/customer/save`** создаёт или обновляет клиента. За логику отвечает `Customer::save()`, в модели `CustomerModel::create()` (для новых) и `CustomerModel::edit()` (для существующих).
- **POST `/customer/delete`** удаляет клиента по идентификатору; каскадные удаления продолжаются на оборудование и связанные сущности.

## Бизнес-правила
- **Привязка к пользователю** все запросы фильтруются по `creator`, поэтому каждый пользователь видит только своих клиентов и их инфраструктуру.
- **Иерархия клиентов** дочерние клиенты (`childs`) отображаются с отступом и наследуют каскадное удаление от родителя (`CustomerModel::delete()`).
- **Валидация** на фронтенде запрещено выбирать клиента в качестве собственного родителя (`script.js`, проверка `sendData.customerId == sendData.parentId`).
- **Удаление** сопровождается предупреждением об удалении оборудования, заявок и платежей.

## Требования к базе данных
- **Столбец `creator`** должен присутствовать в таблице `customer` (тип `INT UNSIGNED`). Если он отсутствует в начальном дампе `sql.sql`, требуется миграция для добавления поля и индексирования.
- **Индексы и связи**
  - Внешний ключ `customer.parentId` должен ссылаться на `customer.id`.
  - Внешние ключи `equipment.customer_id`, `request.equipment_id`, `payment.request_id` обеспечивают каскад.

## Расширение функциональности
- **Поиск и фильтры** — добавить методы в `CustomerModel` для выборки по атрибутам и обновить UI.
- **Атрибуты клиента** — при добавлении новых полей расширить форму `#modal-customer` и обработку в `Customer::save()`.
- **Разграничение доступа** — использовать `creator` для фильтрации в отчётах (`ReportModel`) и дополнительных API.

## Диагностика и отладка
- **AJAX-ошибки** отслеживаются в консоли браузера; все обращения идут через `$.post` и `$.getJSON` из `script.js`.
- **Ответы сервера** для `/customer/save` и `/customer/delete` возвращают целочисленные коды, что позволяет определить успех операции по условию `data > 0` или `data == 1`.
- **Перечитка данных** после успешных операций используется редирект на `/customer` (мгновенный перезапрос списка).
